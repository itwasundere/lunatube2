// Generated by CoffeeScript 1.4.0
(function() {
  var cache, contains, globals, load, models, now, query, save;

  if (typeof window !== "undefined") {
    globals = window || module.exports;
  } else {
    globals = module.exports;
  }

  now = function() {
    return (new Date).getTime();
  };

  contains = function(needle, haystack) {
    var el, _i, _len;
    for (_i = 0, _len = haystack.length; _i < _len; _i++) {
      el = haystack[_i];
      if (needle == el) {
        return true;
      }
    }
  };

  globals.store = function(inst, res) {
    if (id) {
      return res(id);
    } else {
      return res(now());
    }
  };

  globals.fetch = function(inst, res) {
    return res({});
  };

  globals.query = function(type, query, res) {
    return res([]);
  };

  models = {};

  cache = {};

  globals.sparkcache = cache;

  save = function(inst) {
    return globals.store(inst, function(id) {
      inst._id = id;
      cache[id] = inst;
      return inst.emit('saved');
    });
  };

  load = function(inst) {
    if (!inst._id) {
      return;
    }
    return globals.fetch(inst, function(attrs) {
      if (inst._attrs) {
        inst._attrs = attrs;
      } else {
        inst._models = attrs;
      }
      cache[inst._id] = inst;
      inst._ready = true;
      return inst.emit('ready');
    });
  };

  query = function(inst, query) {
    var type;
    type = inst._modeltype;
    return globals.query(type, query, function(models) {
      inst._models = models;
      inst._ready = true;
      return inst.emit('ready');
    });
  };

  globals.resolve = function(id, type) {
    if (!id) {
      return null;
    }
    if (cache[id]) {
      return cache[id];
    }
    if (!type) {
      return null;
    }
    return cache[id] = new models[type]({
      _id: id
    });
  };

  globals.gen_class = function(name, schema) {
    var attr, attrs, link;
    if (!schema) {
      schema = {};
    }
    attrs = {};
    for (link in schema.links) {
      attrs['_' + link] = null;
    }
    for (attr in schema.attrs) {
      attrs[attr] = null;
    }
    return (function() {

      function _Class(_construction) {
        var k, v;
        this._construction = _construction;
        for (k in _construction) {
          v = _construction[k];
          if (k in this._attrs) {
            this._attrs[k] = v;
          }
        }
        if (_construction && _construction._id) {
          this._id = _construction._id;
          this.load();
        }
      }

      _Class.prototype._links = schema.links || {};

      _Class.prototype._attrs = attrs;

      _Class.prototype._events = {};

      _Class.prototype._type = name;

      _Class.prototype.get = function(key) {
        if (key in this._attrs) {
          return this._attrs[key];
        }
        if ('_' + key in this._attrs) {
          return resolve(this._attrs['_' + key], this._links[key]);
        }
      };

      _Class.prototype.set = function(key, val) {
        if (key in this._attrs) {
          return this._attrs[key] = val;
        } else if ('_' + key in this._attrs) {
          if (!val._id) {
            console.warn(this._type + ' setting unsaved ' + val._type);
          }
          return this._attrs['_' + key] = val._id;
        }
      };

      _Class.prototype.bind = function(key, res) {
        if (!this._events[key]) {
          this._events[key] = [];
        }
        this._events[key].push(res);
        if (key === 'ready' && this._ready) {
          return res();
        }
      };

      _Class.prototype.emit = function(key, data) {
        var res, _i, _len, _ref, _results;
        if (!this._events[key]) {
          return;
        }
        _ref = this._events[key];
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          res = _ref[_i];
          _results.push(res(data));
        }
        return _results;
      };

      _Class.prototype.save = function() {
        if (save) {
          return save(this);
        }
      };

      _Class.prototype.load = function() {
        if (load) {
          return load(this);
        }
      };

      return _Class;

    })();
  };

  globals.gen_list = function(name, model) {
    return (function() {

      _Class.prototype._type = name + 'list';

      _Class.prototype._modeltype = name;

      _Class.prototype._model = model;

      _Class.prototype._models = [];

      _Class.prototype._events = {};

      function _Class(_construction) {
        this._construction = _construction;
        if (_construction && _construction._id) {
          this._id = _construction._id;
          this.load();
        }
      }

      _Class.prototype.get = function(id) {
        if (contains(id, this._models)) {
          return globals.resolve(id, this._modeltype);
        }
        return null;
      };

      _Class.prototype.at = function(idx) {
        if (this._models[idx]) {
          return globals.resolve(this._models[idx], this._modeltype);
        }
      };

      _Class.prototype.add = function(model, idx) {
        if (!model._id) {
          console.warn(this._type + ' adding unsaved ' + this._modeltype);
        }
        if (idx == null) {
          idx = this._models.length;
        }
        return this._models.splice(idx, 0, model._id);
      };

      _Class.prototype.remove = function(model) {
        var idx;
        idx = this._models.indexOf(model._id);
        if (idx > -1) {
          return this._models.splice(idx, 1);
        }
      };

      _Class.prototype.bind = function(key, res) {
        if (!this._events[key]) {
          this._events[key] = [];
        }
        this._events[key].push(res);
        if (key === 'ready' && this._ready) {
          return res();
        }
      };

      _Class.prototype.emit = function(key, data) {
        var res, _i, _len, _ref, _results;
        if (!this._events[key]) {
          return;
        }
        _ref = this._events[key];
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          res = _ref[_i];
          _results.push(res(data));
        }
        return _results;
      };

      _Class.prototype.save = function(res) {
        if (save) {
          return save(this);
        }
      };

      _Class.prototype.load = function(res) {
        if (load) {
          return load(this);
        }
      };

      _Class.prototype.all = function() {
        return query(this, {});
      };

      _Class.prototype.query = function(filter) {
        return query(this, filter);
      };

      return _Class;

    })();
  };

  globals.spark = function(schemas) {
    var classname, name, schema;
    for (name in schemas) {
      schema = schemas[name];
      classname = name;
      models[name] = globals.gen_class(name, schema);
      models[name + 'list'] = globals.gen_list(name, models[name]);
    }
    return models;
  };

}).call(this);
